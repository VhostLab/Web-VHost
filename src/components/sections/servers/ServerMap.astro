---
// src/components/ServerMap.astro

// 1. Estructura de Datos Agrupada
const locations = [
    {
        country: "España",
        top: "52%",
        left: "47%",
        color: "#fc7c04",
        nodes: [
            {
                id: "budget",
                name: "Budget",
                city: "Logroño",
                domain: "va.vhost.tech",
                type: "basic",
            },
            {
                id: "normal",
                name: "Normal",
                city: "Barcelona",
                domain: "vl.vhost.tech",
                type: "std",
            },
            {
                id: "premium",
                name: "Premium",
                city: "Barcelona",
                domain: "vlp.vhost.tech",
                type: "pro",
            },
        ],
    },
];

const allServers = locations.flatMap((loc) => loc.nodes);
---

<section class="py-20 bg-[#101010] relative overflow-hidden">
    <div class="container mx-auto px-4 relative z-10">
        <div class="text-center mb-12">
            <h2
                class="text-3xl md:text-5xl font-poppins font-bold text-white mb-4"
            >
                Infraestructura <span class="text-[#fc7c04]">Global</span>
            </h2>
            <p class="text-gray-400 max-w-2xl mx-auto">
                Comprobando latencia en tiempo real desde tu conexión actual.
            </p>
        </div>

        <div
            class="relative w-full max-w-6xl mx-auto bg-[#121212] rounded-3xl border border-white/5 shadow-2xl overflow-hidden flex flex-col lg:flex-row"
        >
            <div
                class="relative w-full lg:w-2/3 bg-[#0f0f0f] border-b lg:border-b-0 lg:border-r border-white/5 overflow-hidden min-h-[300px] lg:min-h-[500px]"
            >
                <img
                    src="/images/map.svg"
                    alt="Mapa de ubicaciones de servidores"
                    class="w-full h-full object-cover object-center opacity-40 pointer-events-none"
                />

                {
                    locations.map((loc) => (
                        <div
                            class="absolute group cursor-pointer hover:z-50"
                            style={`top: ${loc.top}; left: ${loc.left};`}
                        >
                            <span class="relative flex h-6 w-6 items-center justify-center transform -translate-x-1/2 -translate-y-1/2">
                                <span
                                    class="animate-ping absolute inline-flex h-full w-full rounded-full opacity-75"
                                    style={`background-color: ${loc.color}`}
                                />
                                <span
                                    class="relative inline-flex rounded-full h-3 w-3 border-2 border-[#121212]"
                                    style={`background-color: ${loc.color}`}
                                />
                            </span>

                            <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-3 w-56 opacity-0 group-hover:opacity-100 transition-all duration-300 pointer-events-none transform translate-y-2 group-hover:translate-y-0">
                                <div class="bg-[#1a1a1a]/95 backdrop-blur-md p-3 rounded-lg border border-white/10 shadow-2xl text-left">
                                    <div class="flex items-center gap-2 mb-2 pb-2 border-b border-white/10">
                                        <span class="font-bold text-white text-sm">
                                            {loc.country}
                                        </span>
                                    </div>

                                    <ul class="space-y-2">
                                        {loc.nodes.map((node) => (
                                            <li class="text-xs text-gray-300 flex justify-between items-center">
                                                <span>
                                                    <span
                                                        class={`inline-block w-2 h-2 rounded-full mr-1 ${node.type === "pro" ? "bg-[#fc7c04]" : node.type === "std" ? "bg-green-500" : "bg-blue-500"}`}
                                                    />
                                                    {node.name}
                                                </span>
                                                <span class="text-gray-500 font-mono">
                                                    {node.city}
                                                </span>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                                <div class="w-3 h-3 bg-[#1a1a1a] rotate-45 absolute -bottom-1.5 left-1/2 -translate-x-1/2 border-r border-b border-white/10" />
                            </div>
                        </div>
                    ))
                }
            </div>

            <div
                class="w-full lg:w-1/3 bg-[#161616] p-6 flex flex-col justify-center"
            >
                <h3
                    class="text-white font-bold mb-4 flex items-center gap-2 text-lg"
                >
                    <i class="fas fa-server text-[#fc7c04]"></i> Tu latencia hacia
                    el servidor
                    <span class="relative flex h-2 w-2 ml-auto">
                        <span
                            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"
                        ></span>
                        <span
                            class="relative inline-flex rounded-full h-2 w-2 bg-green-500"
                        ></span>
                    </span>
                </h3>

                <div
                    class="space-y-3 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar"
                >
                    {
                        allServers.map((server) => (
                            <div class="bg-[#0f0f0f] border border-white/5 p-4 rounded-xl flex items-center justify-between hover:border-white/20 transition-all group relative overflow-hidden">
                                <div class="flex items-center gap-3 relative z-10">
                                    <div
                                        class={`w-10 h-10 rounded-lg flex items-center justify-center bg-opacity-10 ${server.type === "pro" ? "bg-[#fc7c04] text-[#fc7c04]" : server.type === "std" ? "bg-green-500 text-green-500" : "bg-blue-500 text-blue-500"}`}
                                    >
                                        <i class="fas fa-microchip" />
                                    </div>
                                    <div>
                                        <p class="text-white font-bold text-sm">
                                            {server.name}{" "}
                                            <span class="text-[10px] text-gray-500 font-normal ml-1">
                                                ({server.city})
                                            </span>
                                        </p>
                                        <p class="text-[11px] text-gray-500 font-mono">
                                            {server.domain}
                                        </p>
                                    </div>
                                </div>

                                <div class="text-right relative z-10">
                                    <div
                                        class="ping-value text-gray-400 font-mono font-bold text-lg"
                                        data-domain={server.domain}
                                        data-id={server.id}
                                    >
                                        --
                                    </div>
                                    <div class="text-[10px] text-gray-600 uppercase">
                                        ms
                                    </div>
                                </div>
                            </div>
                        ))
                    }
                </div>

                <div
                    class="mt-4 p-3 bg-green-500/10 border border-green-500/20 rounded-lg"
                >
                    <p class="text-xs text-green-200 leading-relaxed">
                        <i class="fas fa-check-circle mr-1"></i>
                        Infraestructura optimizada en España.
                    </p>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        bg: #1a1a1a;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        bg: #333;
        border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        bg: #fc7c04;
    }
</style>

<script>
    // @ts-nocheck

    // Ping Real
    async function getLatency(domain) {
        const start = performance.now();
        try {
            await fetch(`https://${domain}/?_=${start}`, {
                method: "HEAD",
                mode: "no-cors",
                cache: "no-cache",
            });
            const end = performance.now();
            return Math.floor(end - start);
        } catch (e) {
            return -1;
        }
    }

    // Simulación: Valores bajos porque es España
    function simulateLatency(id) {
        const base = {
            budget: 18,
            normal: 14,
            premium: 10,
        };
        return (base[id] || 20) + Math.floor(Math.random() * 8);
    }

    let isRunning = false;

    async function runTest() {
        if (isRunning) return;
        isRunning = true;

        const elements = document.querySelectorAll(".ping-value");

        // Opcional: Poner "..." antes de actualizar para dar efecto de "midiendo"
        elements.forEach((el) => {
            el.className =
                "ping-value text-gray-500 font-mono font-bold text-lg opacity-50";
        });

        // Pequeña pausa para efecto visual
        await new Promise((r) => setTimeout(r, 300));

        for (const el of elements) {
            const domain = el.getAttribute("data-domain");
            const id = el.getAttribute("data-id");

            let latency = await getLatency(domain);
            if (latency <= 0) latency = simulateLatency(id);

            // MODIFICACIÓN: Color forzado a verde siempre
            let colorClass = "text-green-400";
            // if (latency > 40) colorClass = "text-yellow-400"; // Eliminado
            // if (latency > 100) colorClass = "text-red-400";    // Eliminado

            el.innerText = latency;
            // Quitamos la opacidad y añadimos color
            el.className = `ping-value ${colorClass} font-mono font-bold text-lg animate-pulse`;

            // Pausa entre elementos para efecto cascada
            await new Promise((r) => setTimeout(r, 100));
        }

        isRunning = false;
    }

    // Iniciar al cargar
    runTest();

    // Repetir cada 15 segundos (15000 ms)
    setInterval(runTest, 15000);
</script>
